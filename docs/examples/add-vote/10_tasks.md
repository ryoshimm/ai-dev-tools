# タスク分解: add-vote

## 役割構成
- **API**: バックエンド実装（DB マイグレーション、エンドポイント）
- **UI**: フロントエンド実装（投票ボタン、表示）

---

## Task 1: API - 投票機能のバックエンド実装

**担当 worktree**: `feature/add-vote/api`

### スコープ
- votes テーブルの DB マイグレーション作成
- 投票トグル API エンドポイントの実装
- タスク一覧 API に投票数・投票済みフラグを追加

### 許可ファイル
- `db/migrations/`
- `src/api/votes/` (新規)
- `src/api/tasks/` (既存の一覧 API にフィールド追加)
- `src/models/vote.ts` (新規)
- `tests/api/votes/` (新規)
- `tests/api/tasks/` (既存テストの更新)

### 完了条件
- [ ] votes テーブルのマイグレーションが実行可能
- [ ] `POST /api/tasks/:taskId/vote` が正しく動作する（投票 / 取消のトグル）
- [ ] `GET /api/tasks` のレスポンスに `voteCount` と `hasVoted` が含まれる
- [ ] 同一ユーザーの重複投票が DB レベルで防止される
- [ ] 未認証リクエストに 401 を返す
- [ ] 全テストが通る

### やってはいけないこと
- フロントエンドのコードに触れない
- tasks テーブルのスキーマを変更しない
- 既存の tasks CRUD エンドポイントのレスポンス構造を破壊しない

---

## Task 2: UI - 投票機能のフロントエンド実装

**担当 worktree**: `feature/add-vote/ui`

### スコープ
- 投票ボタンコンポーネントの作成
- タスク一覧に投票数・投票ボタンを表示
- 楽観的 UI 更新の実装
- API 完了前はモックデータで開発

### 許可ファイル
- `src/components/VoteButton/` (新規)
- `src/components/TaskList/` (既存、投票ボタン追加)
- `src/hooks/useVote.ts` (新規)
- `src/api/vote.ts` (新規、API クライアント)
- `src/mocks/vote.ts` (新規、開発用モック)
- `tests/components/VoteButton/` (新規)
- `tests/components/TaskList/` (既存テストの更新)

### 完了条件
- [ ] 投票ボタンが各タスクに表示される
- [ ] クリックで投票 / 取消がトグルされる
- [ ] 投票数が表示される
- [ ] 投票済みタスクが視覚的に区別される（例: ボタンの色が変わる）
- [ ] 未認証ユーザーには投票ボタンが表示されない
- [ ] 楽観的 UI 更新が実装されている（クリック即時反映）
- [ ] API 未接続でもモックで動作確認できる
- [ ] 全テストが通る

### やってはいけないこと
- バックエンドのコードに触れない
- 既存のタスク CRUD 機能の動作を変更しない
- `11_api_contract.md` に定義されていない API を呼び出さない

---

## 検証チェックリスト
- [ ] 各タスクのスコープが重複していないか
- [ ] 許可ファイルが明確に分離されているか
- [ ] 完了条件が計測可能か
- [ ] 「やってはいけないこと」が明確か
