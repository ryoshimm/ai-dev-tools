# レビュー・テスト方針: add-vote

---

## レビューチェックリスト

### API worktree (`feature/add-vote/api`)

- [ ] `votes` テーブルのマイグレーションが `00_spec.md` のデータモデルと一致
- [ ] `UNIQUE(task_id, user_id)` 制約が存在する
- [ ] `POST /api/tasks/:taskId/vote` が `11_api_contract.md` 通りのレスポンスを返す
- [ ] `GET /api/tasks` に `voteCount` / `hasVoted` が追加されている
- [ ] 未認証リクエストに 401 を返す
- [ ] 存在しないタスクへの投票に 404 を返す
- [ ] トランザクションが適切に使われている
- [ ] N+1 問題が発生していない
- [ ] 既存の tasks CRUD エンドポイントに影響がない
- [ ] tasks テーブルのスキーマが変更されていない

### UI worktree (`feature/add-vote/ui`)

- [ ] VoteButton コンポーネントが作成されている
- [ ] 投票 / 取消のトグル動作が正しい
- [ ] 投票済み / 未投票の視覚的な区別がある
- [ ] 未認証ユーザーに投票ボタンが表示されない
- [ ] 楽観的 UI 更新が実装されている
- [ ] API エラー時のロールバック処理がある
- [ ] `11_api_contract.md` に定義されていない API を呼んでいない
- [ ] 既存の TaskList のレイアウトが大きく変わっていない

---

## テスト方針

### API テスト

**単体テスト:**
- Vote モデルの CRUD 操作
- 投票トグルのロジック（投票 → 取消 → 再投票）
- 重複投票の防止（UNIQUE 制約エラーのハンドリング）

**結合テスト:**
- `POST /api/tasks/:taskId/vote` の正常系・異常系
  - 認証済み: 投票成功 → 200 + `{ voted: true, voteCount: N }`
  - 認証済み（投票済み）: 取消成功 → 200 + `{ voted: false, voteCount: N }`
  - 未認証: → 401
  - 存在しないタスク: → 404
- `GET /api/tasks` のレスポンスに `voteCount` / `hasVoted` が含まれること
- 既存の tasks CRUD テストが壊れていないこと

### UI テスト

**コンポーネントテスト:**
- VoteButton の表示（未投票 / 投票済み / 非表示）
- クリックイベントで `onToggle` が呼ばれること
- `disabled` 状態の動作

**フックテスト:**
- `useVote` の楽観的更新（即時反映）
- API 成功時の状態更新
- API 失敗時のロールバック

---

## 受け入れ条件

1. 認証済みユーザーがタスクに投票・取消できる
2. 投票数がタスク一覧に正しく表示される
3. 投票済みタスクが視覚的に区別される
4. 未認証ユーザーには投票ボタンが表示されない
5. 既存のタスク CRUD 機能が壊れていない
6. 全テスト（API + UI）が通る

---

## 検証チェックリスト
- [ ] レビュー項目が `00_spec.md` の要件を網羅しているか
- [ ] テストケースが正常系・異常系を含んでいるか
- [ ] 受け入れ条件がユーザーの期待と一致しているか
