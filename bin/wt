#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
wt: git worktree helper for parallel AI development

Usage:
  wt create <feature> [subtask...]
  wt remove <feature> [subtask...]
  wt list
  wt help

Examples:
  # サブタスクなし（1 worktree）
  wt create add-vote

  # サブタスクで分割（複数 worktree）
  wt create add-vote button display
  wt create add-vote ui api

  # 削除
  wt remove add-vote
  wt remove add-vote button display
USAGE
}

die() { echo "Error: $*" >&2; exit 1; }

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
[[ -n "$ROOT" ]] || die "not inside a git repository"
cd "$ROOT"

CMD="${1:-help}"
shift || true

FEATURE=""
SUBTASKS=()

# parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    *)
      if [[ -z "$FEATURE" ]]; then
        FEATURE="$1"
      else
        SUBTASKS+=("$1")
      fi
      shift
      ;;
  esac
done

WT_DIR="wt"

ensure_main_ready() {
  git show-ref --verify --quiet refs/heads/main || die "branch 'main' not found"
  git switch main >/dev/null 2>&1 || die "failed to switch to main"
  git pull --rebase >/dev/null 2>&1 || true
}

create_one() {
  local branch="$1" path="$2"

  if [[ -e "$path" ]]; then
    echo "Skip: path exists: $path"
    return
  fi

  if git show-ref --verify --quiet "refs/heads/${branch}"; then
    git worktree add "$path" "$branch"
  else
    git worktree add -b "$branch" "$path" main
  fi

  echo "Created: $path [$branch]"
}

remove_one() {
  local path="$1"

  if [[ -e "$path" ]]; then
    git worktree remove "$path"
    echo "Removed: $path"
  else
    echo "Skip: not found: $path"
  fi
}

case "$CMD" in
  create)
    [[ -n "$FEATURE" ]] || { usage; exit 1; }
    mkdir -p "$WT_DIR"
    ensure_main_ready

    if [[ ${#SUBTASKS[@]} -eq 0 ]]; then
      # サブタスクなし: 1 worktree
      create_one "feature/${FEATURE}" "${WT_DIR}/${FEATURE}"
    else
      # サブタスクあり: サブタスクごとに worktree
      for subtask in "${SUBTASKS[@]}"; do
        create_one "feature/${FEATURE}/${subtask}" "${WT_DIR}/${FEATURE}-${subtask}"
      done
    fi
    ;;
  remove)
    [[ -n "$FEATURE" ]] || { usage; exit 1; }

    if [[ ${#SUBTASKS[@]} -eq 0 ]]; then
      remove_one "${WT_DIR}/${FEATURE}"
    else
      for subtask in "${SUBTASKS[@]}"; do
        remove_one "${WT_DIR}/${FEATURE}-${subtask}"
      done
    fi
    ;;
  list)
    git worktree list
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    usage
    die "unknown command: $CMD"
    ;;
esac
