#!/usr/bin/env bash
set -euo pipefail

# templates/skills/<skill-name>/ を ~/.claude/skills/<skill-name> に
# シンボリックリンクで展開する（ディレクトリ単位）
# すでにリンクが存在する場合はスキップする

# ai-dev-tools リポジトリのルートを特定（シンボリックリンクを解決）
REAL_SCRIPT="$(readlink -f "$0" 2>/dev/null || readlink "$0")"
SCRIPT_DIR="$(cd "$(dirname "$REAL_SCRIPT")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATES_DIR="$REPO_DIR/templates/skills"
TARGET_DIR="$HOME/.claude/skills"

if [[ ! -d "$TEMPLATES_DIR" ]]; then
  echo "Error: templates/skills/ が見つかりません: $TEMPLATES_DIR" >&2
  exit 1
fi

mkdir -p "$TARGET_DIR"

echo "== setup-skills =="
echo "Source: $TEMPLATES_DIR"
echo "Target: $TARGET_DIR"
echo ""

linked=()
skipped=()

for src in "$TEMPLATES_DIR"/*/; do
  [[ -d "$src" ]] || continue
  [[ -f "$src/SKILL.md" ]] || continue
  name="$(basename "$src")"
  dest="$TARGET_DIR/$name"

  if [[ -e "$dest" ]]; then
    skipped+=("$name")
  else
    ln -s "$src" "$dest"
    linked+=("$name")
  fi
done

if [[ ${#linked[@]} -gt 0 ]]; then
  echo "展開済み:"
  for f in "${linked[@]}"; do
    echo "  + $f/"
  done
fi

if [[ ${#skipped[@]} -gt 0 ]]; then
  echo "スキップ（既に存在）:"
  for f in "${skipped[@]}"; do
    echo "  - $f/"
  done
fi

if [[ ${#linked[@]} -eq 0 && ${#skipped[@]} -eq 0 ]]; then
  echo "展開対象の skill がありません。"
fi

echo ""
echo "Done."
